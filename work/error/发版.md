# 发版

### 前端代码发布未获得预期效果

#### 1.问题现象:

* 安排晚上上线,研发最后再uat1环境测试,反馈uat1环境前端代码发布后,页面没有预期改变,怀疑jenkins有问题

#### 2.定位过程

1. 查看jenkins日志,发现一切正常
2. 登录ansible服务器,查看拉下来的代码包,git分支,以及版本号等,确认无误,反馈给研发,然后建议研发新增一个test文件,我重新发包
3. 新增test文件后,重新发包,test文件已发布,确认发布无误,研发坚持还是发包有问题
4. 找研发要了他新增的详细代码,去到ansible服务器上查到对应的代码,反馈给研发
5. 研发去dev环境验证,并说明dev1和uat1代码一样,但效果不一样,明确他那边没问题
6. 我让研发修改其他正常页面,如果有改变,说明他代码问题,如果没改变,说明不是代码问题
7. 修改正常页面后,还是没效果,我才认真考虑起这个问题
8. 查看cmdb前端配置,发现nginx配置都没点生成,一下明确,大概是运维侧的问题
9. 点击生成nginx配置后,再检查nginx配置,发现一切正常,再次发包,发现还是未生效
10. ping请求域名,发现域名的nginx地址与cmdb上生成的nginx地址不同
11. 将cmdb上该服务的前端地址绑定到与域名一致的服务器
12. 再次发包,前端界面显示预期结果

#### 3.问题原因

* 周一做了fat4和uat1环境的nginx迁移,将公司内部服务的域名全部部署到一台app服务器上,对外的域名,全部部署在一台nginx服务器上,配置文件都做了迁移,但是对应服务绑定的服务器没有修改
* 原nginx服务器上的前端代码都没有删除,所以正常的访问是可以,但是发布代码没效果

#### 4.导致后果

* 导致预计晚上发布的版本,没能发布,推迟一天

#### 5.思考

1. 本次问题定位,从一开始就被研发带偏,忽略了实际问题,耗费过多时间与研发争论jenkins发布是否正常
2. 到后面,其实已经觉得研发有点无理取闹,一直坚持定位问题的原因,是我自己想说服对方是他的错误
3. 反思一下,从个人性格来说,过程中有点急躁,后来就没有真心实意的去想着帮对方解决问题
4. 反思二下,忽略了对方的实际诉求是代码没生效,但是却把主焦点放在了jenkins上

### 前端请求问题

#### 1.问题现象:

* 背景:前端要求配置多个二级目录,已访问不同前端项目;前端目录为:一个main目录为/目录,其他项目放在与main同级的sub目录下,各自一个子目录
* nginx配置完成后,请求对应url,页面显示空白,查看nginx日志访问正常,F12,发现js请求一片红,js路径配置错误
* 前端修改代码后,继续请求,请求成功,但是刷新页面后,页面报404
* 查看nginx日志,报alias没权限rewrite...

#### 2.问题原因

* rewrite语法的url后,写的是break,改成last后,可以正常请求



### 灰度发布

#### 问题现象

灰度发布时,测试反馈灰度司机接不到单

#### 问题原因

个人问题导致.发布时准备了2个文档,一个是常用命令文档,一个是发版流程文档;第二个文档脱胎于第一个文档,都有灰度刷用户的命令;发布完成后,由于太忙,测试再次让加灰度用户时,错把新加的灰度用户放到旧的文档里了;导致本次的灰度用户,只有最新的添加进去了,其他的都被刷掉了;反复2-3次

有司机和taxi两种用户;不清楚第二种,导致测试提供的taxi手机号,查的是driver库的信息,uid不一致,添加无效的灰度用户

#### 改进方法

1. 细心一些
2. 流程有些不合理;总是会出现临时新加灰度用户的情况;针对这种情况,最好与测试沟通好,提前准备好,不要出现临时修改的情况
3. 添加灰度用户是手动通过查数据库获取的,再手动添加,如果可以通过平台化或者自动化,提高自动化,减少人为操作,或许可以降低一些不必要的失误

### 凌晨发版1

#### 问题现象

1. oa服务jenkins发包失败，原因是ansible上传包解压命令失败
2. fileexportimpl连接数据库异常
3. 测试反馈oa前端代码未生效
4. 测试验证时反馈程序异常，日志显示RPC请求失败
5. nginx任务下成功，但配置未下发成功

#### 问题原因

1. nginx配置未下发成功：/etc/ansible/hosts文件里没有配nginx服务器的ip,导致未成功下发，报`No hosts matched, nothing to do`

2. fileexportimpl连接数据库异常：连接oa库异常，oa已从腾讯云迁移到华为云，apollo的oa库地址未及时修改，修改后正常

3. oa问题：

   * 目标服务器python问题，导致下发ansible命令失败

   * 手动上传包到服务器上部署，坑来了，因为oa前几天迁移到华为云了，但是并未用jenkins部署，所以jenkins上显示上次部署成功的ip还是腾讯云的，结果手动部署到旧的服务器上了，结果就是测试反馈代码好像未生效，后来发现后重新部署到华为云服务器，并停掉腾讯云上的服务
   * 程序异常原因：旧的腾讯云的应用未停，部分应用连接的还是腾讯云的应用，结果报程序异常，重启服务后正常

总结

* oa旧的应用未停，从腾讯云迁移到华为云已经接近1周，还有服务连的腾讯云的服务，这个未能及时发现
* 部署oa应用未用jenkins，导致发版时才发现jenkins部署失败
* 不够细心，没有从jenkins日志去拿应用ip，而是从上次发布成功的那里拿的ip，导致部署到腾讯云，无效操作
* 程序异常时，排查不够细心，没有留意到是连接腾讯云的ip，浪费了比较多时间 ，而且排查方向一直错误，以为是nginx配置问题

### 凌晨发版2

> 凌晨发版后,顺便把之前clb切换的旧的clb释放了

#### 问题:

早上问题接口超时

#### 问题定位:

登录对应nginx服务器,发现error日志请求的upstream是旧的clb地址

#### 问题原因:

1. 上周做过clb切换,凌晨时把旧的clb释放了
2. clb已切换一周,还有少量流量,运维人员未仔细核实流量的出处
3. 业务请求有几个接口,报超时的是h5页面
4. nginx的域名解析直接依赖宿主机的/etc/resolv.conf配置的DNS服务器;nginx无视TTL并缓存DNS记录,直到下一次重启或配置重载

问题处理

* nginx -s reload
