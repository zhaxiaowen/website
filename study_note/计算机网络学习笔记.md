## 计算机网络学习笔记

> ICMP协议

* 查询报文:ping
* 差错报文:traceroute
  * 设置特殊的TTL,追踪去往目的地时沿途的路由器;Traceroute会发送一份UDP数据报给主机,端口号大于30000,当数据到达时,目的主机的UDP会产生"端口不可达"错误ICMP报文



> 流量走向

1. 数据包先进入mangle表的PREROUTING链,在这里可以改变数据包头内容,再进入nat表的PREROUTING链,做Dnat
2. 进入路由判断,判断包是本地的还是转发
3. 本地的就进入INPUT链,之后按条件过滤进入
4. 之后进入本机,再进入OUTPUT链,按条件过滤限制出去
5. 转发的进入FORWARD链,根据条件过滤限制转发
6. 最后进入POSTROUTING链,做Snat,离开本机

![image-20230226113430615](..\picture\image-20230226113430615.png)

![image-20230226113819928](..\picture\image-20230226113819928.png)

> 云服务的安全组如何实现的

* 两个VM都是通过tap网卡连接到br0上的,但是网桥是二层的,两个VM之间是互通的
* 多家一个sg-br网桥,在这个网桥上配置iptables规则,将用户在界面上配置的规则,放到这个网桥上,然后再每台VM上跑一个agent,将用户配置的安全组变成iptables规则,配置在这个网桥上
* 主要是通过filter表实现的



![image-20230226113911364](..\picture\image-20230226113911364.png)

> Overlay网络

* 基于物理网络(Underlay)的虚拟化网络实现
* GRE
  *  IP-over-IP的隧道技术,它将IP包封装在GRE包里,外面加上IP头,在隧道的一端封装数据包,并在通路上进行传输,到另一端的时候解封装
  * 当隧道建立后,会多出两个Tunnel端口,用于封包,解包
  * 不足
    * Tuneel数量问题,GRE是点对点隧道,如果有3个网络,就需要每个网络两两建立隧道
    * GRE不支持组播,一个网络的虚拟机发出广播帧后,GRE会将其广播到所有与该节点有隧道连接的节点
    * 有很多防火墙和三层网络设备无法解析GRE,因此它们无法对GRE封装包做合适地过滤和负载均衡

![image-20230226144607729](..\picture\image-20230226144607729.png)

![image-20230226144649972](..\picture\image-20230226144649972.png)

* VXLAN
  * VXLAN是从二层外面套了一个VXLAN的头
  * VXLAN包进行封装和解包的地方叫VTEP,每台物理机都有一个VTEP,每个虚拟机启动后,都像这个VTEP管家注册;当虚拟机需要跨VTEP通信,需要通过VTEP代理,由VTEP进行包的封装和解封装

![image-20230226145559696](..\picture\image-20230226145559696.png)

> Flannel

* UDP

  * 每个node上有个flannel.1网卡,发到这个网卡的包会被flanneld进程读取,然后封装到UDP包里,外层加上其他node的ip,然后发给对应node的flanneld

* VXLAN

  ![image-20230226152135977](..\picture\image-20230226152135977.png)

* host-gw

  * 通过配置静态路由的方式实现,因此每个node必须在同一个lan子网内
  * 不需要额外的封包拆包

> Calico

* 将转发全部用三层网络的路由转发来实现,即不走Overlay,不引入另外的网络性能损耗
* IPIP
  * tunlo设备封装数据,形成隧道,承载流量
  * 适用于互相发往的pod不在同一个网段中,跨网段访问的场景,外层封装的ip能够解决跨网段的路由问题
* BGP
  * 使用路由信息导向流量
  * 使用与互相访问的pod在同一网段,适用于大型网络