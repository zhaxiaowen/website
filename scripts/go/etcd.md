# http_apollo

```
package main

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"log"
	"net/http"
	"net/url"
	"regexp"
	"strconv"
	"strings"
)

const BC = "https://apollo-prod-wyc.wsecar.cn/apps/service_name/envs/PRO/clusters/default/namespaces"

type AutoGenerated struct {
	BaseInfo struct {
		ID                         int    `json:"id"`
		AppID                      string `json:"appId"`
		ClusterName                string `json:"clusterName"`
		NamespaceName              string `json:"namespaceName"`
		DataChangeCreatedBy        string `json:"dataChangeCreatedBy"`
		DataChangeLastModifiedBy   string `json:"dataChangeLastModifiedBy"`
		DataChangeCreatedTime      string `json:"dataChangeCreatedTime"`
		DataChangeLastModifiedTime string `json:"dataChangeLastModifiedTime"`
	} `json:"baseInfo"`
	ItemModifiedCnt int `json:"itemModifiedCnt"`
	Items           []struct {
		Item struct {
			ID                         int    `json:"id"`
			NamespaceID                int    `json:"namespaceId"`
			Key                        string `json:"key"`
			Value                      string `json:"value"`
			Comment                    string `json:"comment"`
			LineNum                    int    `json:"lineNum"`
			DataChangeCreatedBy        string `json:"dataChangeCreatedBy"`
			DataChangeLastModifiedBy   string `json:"dataChangeLastModifiedBy"`
			DataChangeCreatedTime      string `json:"dataChangeCreatedTime"`
			DataChangeLastModifiedTime string `json:"dataChangeLastModifiedTime"`
		} `json:"item"`
		IsModified bool `json:"isModified"`
		IsDeleted  bool `json:"isDeleted"`
	} `json:"items"`
	Format         string `json:"format"`
	IsPublic       bool   `json:"isPublic"`
	ParentAppID    string `json:"parentAppId"`
	Comment        string `json:"comment"`
	IsConfigHidden bool   `json:"isConfigHidden"`
}

// 发送一个简单的http GET请求
func httpSimpleGet() {
	resp, err := http.Get(BC + "index?aa=AA&bb=BB")
	if err != nil {
		log.Println(err)
	}
	defer resp.Body.Close()
	// 获取响应内容
	resultByte, _ := ioutil.ReadAll(resp.Body)
	fmt.Println(string(resultByte))
}

func ParseResponse(response *http.Response) ([]interface{}, error) {
	result := make([]interface{}, 1, 10)
	body, err := ioutil.ReadAll(response.Body)
	if err == nil {
		err = json.Unmarshal(body, &result)

	}

	return result, err
}

// 设置请求头和请求参数的Get请求
func httpGet(service_name string) {

	url := strings.Replace(BC, "service_name", service_name, 1)
	client := &http.Client{}
	request, err := http.NewRequest("GET", url, nil)
	if err != nil {
		log.Println(err)
	}
	// 在请求头中添加自定义数据
	//request.Header.Add(http.Cookie{}, "PG")
	request.Header.Add("Cookie", "NG_TRANSLATE_LANG_KEY=zh-CN; JSESSIONID=FB8B4CE58A18497B1A744738931B3270")
	// 添加请求参数
	params := request.URL.Query()
	//params.Add("name", "pg")
	//params.Add("addr", "chain")
	request.URL.RawQuery = params.Encode()
	// 发送http请求,请求成功,获取响应
	resp, err := client.Do(request)
	if err != nil {
		log.Println(err)
	}
	// 获取所有的响应内容
	result, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		log.Println(err)
	}
	var v1 []AutoGenerated
	er := json.Unmarshal(result, &v1)
	if er != nil {
		fmt.Println(er)
	}
	for _, generated := range v1 {
		if generated.BaseInfo.NamespaceName == "wanshunCar.mysql" {
			for _, item := range generated.Items {
				if item.Item.Key == "druid.url" {
					//fmt.Println(item.Item.Value)
					exp := regexp.MustCompile(`.*mysql://(.*)\?`)
					result := exp.FindAllStringSubmatch(item.Item.Value, -1)
					fmt.Println(result)
					for _, i2 := range result {
						fmt.Println(i2[1])
					}

				}

			}
		}

	}

}

// http POST请求,并发送json数据
func httpPostJson() {
	// post json 数据应用比较广泛
	// 发送json数据,我们一般是用使用map或者结构体存储数据
	// 然后转换成json数据
	// 然后转换成byte数据,放在发送的body中一起发送
	// 我们模拟一下这个过程
	var std map[string]string = map[string]string{"work": "programmer", "skills": "golang", "addr": "北京"}
	data, err := json.Marshal(std)
	if err != nil {
		log.Println(err)
	}
	body := bytes.NewBuffer([]byte(data))
	req, err := http.NewRequest("POST", BC, body)
	if err != nil {
		log.Println(err)
	}
	// 设置请求头
	req.Header.Add("Accept", "application/json")
	req.Header.Add("Content-Type", "application/json")
	resp, err := http.DefaultClient.Do(req)
	defer resp.Body.Close()

	result, err := ParseResponse(resp)
	if err != nil {
		log.Fatalln(err)

	}
	fmt.Println(result)
	//fmt.Println(json.Unmarshal(result, "2"))
}

// 模拟post发送表单数据
func HttpPosForm() {
	formData := url.Values{}
	formData.Set("userName", "admin")
	formData.Set("userPwd", "admin123456")
	req, err := http.NewRequest("POST", BC, strings.NewReader(formData.Encode()))
	if err != nil {
		log.Println(err)
	}
	req.Header.Set("Content-Type", "application/x-www-form-urlencoded")
	req.Header.Set("Content-Length", strconv.Itoa(len(formData.Encode())))
	resp, err := http.DefaultClient.Do(req)
	if err != nil {
		log.Println(err)
	}
	defer resp.Body.Close()
	result, err := ioutil.ReadAll(resp.Body)
	fmt.Println(string(result))

}

// 模拟客户端发送PUT请求
func HttpPut() {
	// 发送PUT请求和POST请求类似都可以发送json和form数据
	std := map[string]string{"method": "PUT"}
	data, err := json.Marshal(std)
	if err != nil {
		log.Println(err)
	}
	body := bytes.NewBuffer([]byte(data))
	req, err := http.NewRequest("PUT", BC, body)
	if err != nil {
		log.Println(err)
	}
	req.Header.Add("Content-Type", "application/json")
	resp, err := http.DefaultClient.Do(req)
	defer resp.Body.Close()
	if err != nil {
		log.Println(err)
	}
	result, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		log.Println(err)
	}
	fmt.Println(string(result))
}

//模拟客户端发送DELETE请求
func HttpDelete() {
	req, err := http.NewRequest("DELETE", BC, nil)
	if err != nil {
		log.Println(err)
	}
	// 添加请求参数 与发送get请求类似
	params := req.URL.Query()
	params.Add("user", "pahnaskdjalsdklasd")
	req.URL.RawQuery = params.Encode()
	// 发送http请求,请求成功,获取响应
	resp, err := http.DefaultClient.Do(req)
	if err != nil {
		log.Println(err)
	}
	// 获取所有的响应内容
	result, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		log.Println(err)
	}
	// 打印响应的内容
	fmt.Println(string(result))
}
func main() {

	//httpSimpleGet()
	httpGet("driver")

}


```